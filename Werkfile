config profile = "debug"

let werk-vscode-version = shell "jq --raw-output .version werk-vscode/package.json" 

let cargo-profile = profile | match {
    "debug" => "dev"
    "%" => "{%}"
}

build "werk-vscode/node_modules" {
    from ["werk-vscode/package.json", "werk-vscode/package-lock.json"]
    run ["npm --prefix werk-vscode install", "touch <out>"]
}
build "/werk-vscode/werk-{werk-vscode-version}.vsix" {
    from ["werk-vscode/node_modules", glob "werk-vscode/**/*"]
    run "npm --prefix werk-vscode run package -- --out ../target/werk-vscode"
}
build "/book/book" {
    run "mdbook build book --dest-dir book/book"
}
build "{profile}/werk{EXE_SUFFIX}" {
    depfile "{profile}/werk.d"

    run "cargo build --profile {cargo-profile}"
}
build "/wasm32-unknown-unknown/{profile}/wasm_glue.wasm" {
    depfile "{out:.wasm=.d}" 
    run "cargo build --manifest-path werk-vscode/wasm-glue/Cargo.toml --target wasm32-unknown-unknown --profile {cargo-profile}"
}
build "wasm-bindgen/{profile}/wasm_glue.js" {
    let out-dir = "{profile}/wasm-bindgen"

    from "wasm32-unknown-unknown/{profile}/wasm_glue.wasm";
    run "wasm-bindgen --target web target/wasm32-unknown-unknown/{profile}/wasm_glue.wasm --out-dir <out:dir>"
}


task vscode-install-extension {
    let vsix = "/werk-vscode/werk-{werk-vscode-version}.vsix"
    build vsix
    run "code --install-extension <vsix>"
}

task cli-install {
    run "cargo install --path werk-cli"
}

task mdbook-serve {
    run "mdbook serve book"
}